/* @flow */'use strict';

require('isomorphic-fetch');

var url = require('@splitsoftware/splitio-utils/lib/url');
var log = require('debug')('splitio-cache:http');

var mySegmentMutationsFactory = require('../mutators/mySegments');

/*::
  type MySergmentsRequest = {
    authorizationKey: string,
    key: string
  }
*/
function mySegmentsDataSource(_ref /*: MySergmentsRequest */) /*: Promise */{
  var authorizationKey = _ref.authorizationKey;
  var key = _ref.key;

  return fetch(url('/mySegments/' + key), {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + authorizationKey
    }
  }).then(function (resp) {
    return resp.json();
  }).then(function (json) {
    log('[' + authorizationKey + '] /mySegments for ' + key, json);

    return json.mySegments.map(function (segment) {
      return segment.name;
    });
  }).then(function (mySegments) {
    return mySegmentMutationsFactory(mySegments);
  }).catch(function (error) {
    log('[' + authorizationKey + '] failure fetching my segments [' + key + ']');

    return error;
  });
}

module.exports = mySegmentsDataSource;
//# sourceMappingURL=mySegments.js.map